WITH cleaned_data AS (
    SELECT 
        cp.ACCOUNT_ID,
        a.ACCOUNT_NAME,
        ROUND(cp.CHURN_PROBABILITY * 100, 2) as CHURN_RISK_PCT,
        cp.CHURN_PREDICTION,
        ROUND(s.MRR_AMOUNT, 2) as MRR,
        ROUND(s.ARR_AMOUNT, 2) as ARR
    FROM (
        SELECT 
            ACCOUNT_ID,
            CHURN_PROBABILITY,
            CHURN_PREDICTION,
            PREDICTION_DATE
        FROM SAAS_R.GOLD.CHURN_PREDICTIONS
        QUALIFY ROW_NUMBER() OVER (PARTITION BY ACCOUNT_ID ORDER BY PREDICTION_DATE DESC, CHURN_PROBABILITY DESC) = 1
    ) cp
    JOIN SAAS_R.SILVER.ACCOUNTS a ON cp.ACCOUNT_ID = a.ACCOUNT_ID
    LEFT JOIN (
        SELECT 
            ACCOUNT_ID,
            MRR_AMOUNT,
            ARR_AMOUNT
        FROM SAAS_R.SILVER.SUBSCRIPTIONS
        QUALIFY ROW_NUMBER() OVER (PARTITION BY ACCOUNT_ID ORDER BY START_DATE DESC) = 1
    ) s ON a.ACCOUNT_ID = s.ACCOUNT_ID
    WHERE a.CHURN_FLAG = FALSE
)
SELECT 
    CASE 
        WHEN CHURN_RISK_PCT >= 50 THEN 'Critical (50%+)'
        WHEN CHURN_RISK_PCT >= 30 THEN 'High (30-49%)'
        WHEN CHURN_RISK_PCT >= 15 THEN 'Medium (15-29%)'
        ELSE 'Low (<15%)'
    END as RISK_LEVEL,
    COUNT(*) as ACCOUNT_COUNT,
    ROUND(SUM(MRR), 2) as TOTAL_MRR,
    ROUND(SUM(ARR), 2) as TOTAL_ARR
FROM cleaned_data
GROUP BY RISK_LEVEL
ORDER BY 
    CASE 
        WHEN RISK_LEVEL = 'Critical (50%+)' THEN 1
        WHEN RISK_LEVEL = 'High (30-49%)' THEN 2
        WHEN RISK_LEVEL = 'Medium (15-29%)' THEN 3
        ELSE 4
    END;