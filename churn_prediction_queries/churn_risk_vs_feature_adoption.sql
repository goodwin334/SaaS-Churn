WITH cleaned_data AS (
    SELECT 
        cp.ACCOUNT_ID,
        a.ACCOUNT_NAME,
        ROUND(cp.CHURN_PROBABILITY * 100, 2) as CHURN_RISK_PCT,
        cp.CHURN_PREDICTION,
        cf.UNIQUE_FEATURES_USED,
        ROUND(s.MRR_AMOUNT, 2) as MRR
    FROM (
        SELECT 
            ACCOUNT_ID,
            CHURN_PROBABILITY,
            CHURN_PREDICTION,
            PREDICTION_DATE
        FROM SAAS_R.GOLD.CHURN_PREDICTIONS
        QUALIFY ROW_NUMBER() OVER (PARTITION BY ACCOUNT_ID ORDER BY PREDICTION_DATE DESC, CHURN_PROBABILITY DESC) = 1
    ) cp
    JOIN SAAS_R.SILVER.ACCOUNTS a ON cp.ACCOUNT_ID = a.ACCOUNT_ID
    LEFT JOIN (
        SELECT 
            ACCOUNT_ID,
            MRR_AMOUNT
        FROM SAAS_R.SILVER.SUBSCRIPTIONS
        QUALIFY ROW_NUMBER() OVER (PARTITION BY ACCOUNT_ID ORDER BY START_DATE DESC) = 1
    ) s ON a.ACCOUNT_ID = s.ACCOUNT_ID
    LEFT JOIN (
        SELECT 
            ACCOUNT_ID,
            UNIQUE_FEATURES_USED
        FROM SAAS_R.GOLD.CHURN_PREDICTION_FEATURES
        QUALIFY ROW_NUMBER() OVER (PARTITION BY ACCOUNT_ID ORDER BY SIGNUP_DATE DESC, MRR_AMOUNT DESC) = 1
    ) cf ON cp.ACCOUNT_ID = cf.ACCOUNT_ID
    WHERE a.CHURN_FLAG = FALSE
        AND cf.UNIQUE_FEATURES_USED IS NOT NULL
)
SELECT 
    CASE 
        WHEN UNIQUE_FEATURES_USED <= 2 THEN '1-2 Features'
        WHEN UNIQUE_FEATURES_USED <= 4 THEN '3-4 Features'
        WHEN UNIQUE_FEATURES_USED <= 6 THEN '5-6 Features'
        ELSE '7+ Features'
    END as FEATURE_ADOPTION,
    COUNT(*) as ACCOUNT_COUNT,
    ROUND(AVG(CHURN_RISK_PCT), 2) as AVG_CHURN_RISK,
    SUM(CASE WHEN CHURN_PREDICTION = TRUE THEN 1 ELSE 0 END) as HIGH_RISK_COUNT
FROM cleaned_data
GROUP BY FEATURE_ADOPTION
ORDER BY AVG_CHURN_RISK DESC;