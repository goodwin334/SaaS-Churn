WITH cleaned_data AS (
    SELECT 
        cp.ACCOUNT_ID,
        a.ACCOUNT_NAME,
        a.INDUSTRY,
        a.PLAN_TIER,
        a.COUNTRY,
        a.REFERRAL_SOURCE,
        ROUND(s.MRR_AMOUNT, 2) as MRR,
        ROUND(s.ARR_AMOUNT, 2) as ARR,
        s.SEATS,
        ROUND(cp.CHURN_PROBABILITY * 100, 2) as CHURN_RISK_PCT,
        cp.CHURN_PREDICTION,
        cp.PREDICTION_DATE,
        cf.TOTAL_TICKETS,
        cf.URGENT_TICKETS,
        ROUND(cf.AVG_SATISFACTION_SCORE, 2) as AVG_SATISFACTION,
        cf.TOTAL_ERRORS,
        cf.UNIQUE_FEATURES_USED
    FROM (
        SELECT 
            ACCOUNT_ID,
            CHURN_PROBABILITY,
            CHURN_PREDICTION,
            PREDICTION_DATE
        FROM SAAS_R.GOLD.CHURN_PREDICTIONS
        QUALIFY ROW_NUMBER() OVER (PARTITION BY ACCOUNT_ID ORDER BY PREDICTION_DATE DESC, CHURN_PROBABILITY DESC) = 1
    ) cp
    JOIN SAAS_R.SILVER.ACCOUNTS a ON cp.ACCOUNT_ID = a.ACCOUNT_ID
    LEFT JOIN (
        SELECT 
            ACCOUNT_ID,
            MRR_AMOUNT,
            ARR_AMOUNT,
            SEATS
        FROM SAAS_R.SILVER.SUBSCRIPTIONS
        QUALIFY ROW_NUMBER() OVER (PARTITION BY ACCOUNT_ID ORDER BY START_DATE DESC) = 1
    ) s ON a.ACCOUNT_ID = s.ACCOUNT_ID
    LEFT JOIN (
        SELECT 
            ACCOUNT_ID,
            TOTAL_TICKETS,
            URGENT_TICKETS,
            AVG_SATISFACTION_SCORE,
            TOTAL_ERRORS,
            UNIQUE_FEATURES_USED
        FROM SAAS_R.GOLD.CHURN_PREDICTION_FEATURES
        QUALIFY ROW_NUMBER() OVER (PARTITION BY ACCOUNT_ID ORDER BY SIGNUP_DATE DESC, MRR_AMOUNT DESC) = 1
    ) cf ON cp.ACCOUNT_ID = cf.ACCOUNT_ID
    WHERE a.CHURN_FLAG = FALSE
)
SELECT 
    ACCOUNT_NAME,
    CHURN_RISK_PCT,
    MRR,
    PLAN_TIER,
    INDUSTRY
FROM cleaned_data
ORDER BY CHURN_RISK_PCT DESC
LIMIT 20;